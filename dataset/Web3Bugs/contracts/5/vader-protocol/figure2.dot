digraph SDG_core {
  graph [overlap=false, splines=true, rankdir=LR, compound=true];
  node  [fontname="Helvetica", fontsize=10, style="rounded,filled", fillcolor="#f2f2f2"];
  edge  [color="#555555", fontname="Helvetica", fontsize=9];

  subgraph cluster_attacker {
    label="Attacker";
    style="rounded";
    color="#bbbbbb";
    attackUSDV [shape=oval, fillcolor="#ffffff", label="attackUSDV(uint256)\n(attacker entry)"];
  }

  subgraph cluster_gov {
    label="Governance / DAO";
    style="rounded";
    color="#bbbbbb";

    newAddressProposal [label="newAddressProposal(address,string)\n(propose anchor change)"];
    newGrantProposal   [label="newGrantProposal(address,uint256)\n(optional: propose grant)"];
    voteProposal       [label="voteProposal(uint256)\n(vote / execute)"];
    govChecks          [shape=diamond, fillcolor="#ffffff", label="hasQuorum / hasMajority\n(isEqual guards)"];
    finaliseProposal   [label="finaliseProposal(uint256)\n(finalise)"];

    moveRewardAddress  [label="moveRewardAddress(uint256)\n(state change)"];
    moveUtils          [label="moveUtils(uint256)\n(state change)"];
    grantFunds         [label="grantFunds(uint256)\n(value out)"];
  }

  subgraph cluster_anchor {
    label="Anchor / Oracle";
    style="rounded";
    color="#bbbbbb";

    replaceAnchor      [label="replaceAnchor(address,address)\n(anchor swap)"];
    updateAnchorPrice  [label="updateAnchorPrice(address)\n(update price)"];
    getAnchorPrice     [label="getAnchorPrice()\n(price read)"];
  }

  subgraph cluster_pool {
    label="Pools / Swaps / Synths";
    style="rounded";
    color="#bbbbbb";

    swapWithSynthsWithLimit [label="swapWithSynthsWithLimit(...)\n(price-impacting swap)"];
    mintSynth              [label="mintSynth(...)\n(mint path)"];
    burnSynth              [label="burnSynth(...)\n(burn path)"];
    transferOut            [label="transferOut(...)\n(value transfer)"];
  }

  // Core attacker -> governance
  attackUSDV -> newAddressProposal [label="call"];
  attackUSDV -> voteProposal       [label="call"];
  attackUSDV -> finaliseProposal   [label="call"];

  // Governance gating
  voteProposal -> govChecks        [label="control"];
  govChecks    -> finaliseProposal [label="control"];

  // Governance effects that enable exploit
  finaliseProposal -> replaceAnchor     [label="call / state"];
  finaliseProposal -> moveUtils         [label="call / state"];
  finaliseProposal -> moveRewardAddress [label="call / state"];
  finaliseProposal -> grantFunds        [label="call / value"];

  // Anchor manipulation -> pricing
  replaceAnchor     -> updateAnchorPrice [label="call"];
  updateAnchorPrice -> getAnchorPrice    [label="data: price"];

  // Price-dependent trading/minting
  getAnchorPrice -> swapWithSynthsWithLimit [label="data: bounds/price"];
  swapWithSynthsWithLimit -> mintSynth      [label="call / dataflow"];
  mintSynth -> transferOut                  [label="value out"];

  // Optional unwind path (often present)
  mintSynth -> burnSynth [style=dashed, label="optional unwind"];
}
